# Implementation Plan

## Task 1: プロジェクト基盤とAPI通信層の構築

- [ ] 1.1 バックエンド型定義参照とHono RPCクライアントのセットアップ
  - `nuxt.config.ts` にバックエンドソースへのエイリアス設定を追加
  - `tsconfig.json` にパスマッピングを追加
  - `hono` パッケージがインストール済みであることを確認
  - 型参照が正しく解決されることを `nuxi typecheck` で検証
  - _Requirements: 1.5_

- [ ] 1.2 (P) API通信用Composableの実装
  - Hono RPCクライアントを初期化するComposableを作成
  - 環境変数からベースURLを取得し、型安全なクライアントを返却
  - 各APIメソッドの型推論が正しく機能することを確認
  - _Requirements: 1.5, 8.6_

## Task 2: リアルタイム通信の実装

- [ ] 2.1 SSE接続管理Composableの実装
  - EventSourceを使用したSSE接続の確立・切断
  - 接続状態（disconnected/connecting/connected/reconnecting）の管理
  - exponential backoff による自動再接続ロジック
  - `Last-Event-ID` ヘッダーによる欠落イベント回復
  - SSEから受信したゲーム状態をリアクティブに保持
  - _Requirements: 4.1, 4.5, 4.6, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [ ] 2.2 SSEイベントハンドラの実装
  - `state.delta` イベント受信時のゲーム状態更新
  - `state.final` イベント受信時のゲーム終了処理
  - `event.log` イベント受信時のログ追記
  - `rule.hint` イベント受信時のヒント更新
  - `system.error` イベント受信時のエラー通知
  - _Requirements: 4.2, 4.3, 4.4, 4.7, 5.1, 6.1, 6.2, 7.1, 7.2, 7.3, 7.4_

## Task 3: ゲームアクション実行の実装

- [ ] 3.1 アクション実行Composableの実装
  - `placeChip` および `takeCard` アクションの実行ロジック
  - `command_id` の生成による冪等制御
  - アクション実行中フラグとエラー状態の管理
  - _Requirements: 3.1, 3.2, 3.5_

- [ ] 3.2 アクション可否判定とエラーハンドリング
  - 手番プレイヤー判定によるアクション制御
  - チップ0枚時の「チップを置く」無効化判定
  - 競合エラー（409）時の最新状態再取得と再試行促進
  - _Requirements: 3.3, 3.4, 3.6_

## Task 4: セッション作成画面の実装

- [ ] 4.1 セッション作成フォームコンポーネントの実装
  - 2〜7名のプレイヤー情報（ID・表示名）入力UI
  - プレイヤー入力フィールドの動的追加・削除
  - プレイヤー数とID重複のクライアントサイドバリデーション
  - フィールド単位のエラーメッセージ表示
  - _Requirements: 1.1, 1.3, 1.4, 8.3, 8.4_

- [ ] 4.2 セッション作成ページの実装
  - セッション作成フォームの配置とレイアウト
  - API呼び出しによるセッション作成処理
  - 作成成功時のゲーム画面への遷移
  - 作成成功時の各プレイヤー用参加URL表示
  - ローディング状態の表示
  - _Requirements: 1.1, 1.2, 8.2_

## Task 5: ゲームメイン画面の実装

- [ ] 5.1 ゲームページの基本構造とプレイヤー識別
  - ゲームページのルーティング設定
  - URLクエリパラメータからのプレイヤーID取得
  - 観戦モード（playerId なし）の判定
  - SSE接続の開始とクリーンアップ
  - 初期ゲーム状態の取得と表示
  - _Requirements: 8.1, 8.5_

- [ ] 5.2 (P) ゲーム盤面コンポーネントの実装
  - 中央カード番号の大きな表示
  - 中央ポットのチップ数表示
  - 山札の残り枚数表示
  - _Requirements: 2.1, 2.2, 2.6_

- [ ] 5.3 (P) プレイヤーパネルコンポーネントの実装
  - 各プレイヤーの所持チップ数表示
  - 各プレイヤーの獲得カードを連番グループで表示
  - 現在の手番プレイヤーのハイライト表示
  - _Requirements: 2.3, 2.4, 2.5_

- [ ] 5.4 (P) ターンタイマーコンポーネントの実装
  - deadline からの残り時間カウントダウン表示
  - 残り時間が少ない場合の警告色表示
  - _Requirements: 2.7_

- [ ] 5.5 アクションボタンコンポーネントの実装
  - 「チップを置く」「カードを取る」ボタンの配置
  - 手番でない場合のボタン無効化
  - チップ0枚時の「チップを置く」無効化
  - 観戦モード時のボタン非表示
  - 実行中のローディング表示
  - _Requirements: 3.1, 3.2, 3.3, 3.6, 8.2_

- [ ] 5.6 (P) イベントログコンポーネントの実装
  - ターン順でのイベント一覧表示
  - 各イベントのアクター、アクション、タイムスタンプ表示
  - チップ増減の差分表示
  - 新規イベント追加時の自動スクロール
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

## Task 6: ルールヒント機能の実装

- [ ] 6.1 ヒントパネルコンポーネントの実装
  - ヒント取得ボタンの配置
  - APIからのヒント取得処理
  - ヒントテキストと生成時刻の表示
  - warning 強調度時の注意喚起スタイル適用
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

## Task 7: ゲーム結果画面の実装

- [ ] 7.1 結果画面コンポーネントの実装
  - ゲーム終了時の結果画面表示切り替え
  - 各プレイヤーのスコア計算と表示
  - 順位のランク順表示
  - 獲得カードの連番グループ視覚化
  - タイブレーク発生時の理由と結果表示
  - 新しいゲーム開始ボタンの提供
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

## Task 8: UI/UXとエラーハンドリングの仕上げ

- [ ] 8.1 レスポンシブデザインとスタイリング
  - モバイルフレンドリーなレイアウト調整
  - TailwindCSSを使用した一貫したスタイリング
  - 日本語UIテキストの確認
  - _Requirements: 8.1, 8.4_

- [ ] 8.2 (P) エラーハンドリングの統一
  - APIエラーのユーザーフレンドリーなメッセージ表示
  - SSE接続エラー時の再接続UIとフィードバック
  - セッション未存在時のトップページ誘導
  - _Requirements: 3.4, 4.5, 8.3_

## Task 9: 統合と動作確認

- [ ] 9.1 全コンポーネントの統合テスト
  - セッション作成からゲーム終了までの一連のフロー確認
  - SSEによるリアルタイム状態同期の動作確認
  - 競合エラー発生時のリカバリ動作確認
  - 各ブラウザでの表示確認
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
