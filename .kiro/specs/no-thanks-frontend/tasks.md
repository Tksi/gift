# Implementation Plan

## Task 1: 基盤セットアップとエラーメッセージユーティリティ

- [ ] 1.1 エラーコードから日本語メッセージへの変換ユーティリティを作成する
  - バックエンド API のエラーコードを日本語メッセージにマッピング
  - SESSION_NOT_FOUND, PLAYER_COUNT_INVALID, DUPLICATE_PLAYER_ID 等のコードに対応
  - ネットワークエラー用のフォールバックメッセージを含める
  - _Requirements: 8.5_

- [ ] 1.2 (P) 共通エラー表示コンポーネントを作成する
  - エラーメッセージをトースト形式で表示
  - 閉じるボタンとリトライボタンを配置
  - 404 エラー時はホームへの導線を表示
  - レスポンシブ対応 (モバイル/デスクトップ)
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

## Task 2: SSE 接続管理 Composable の実装

- [ ] 2.1 EventSource を使った SSE 接続の確立と切断機能を実装する
  - セッション ID を受け取り SSE エンドポイントへ接続
  - イベント受信時にコールバックを呼び出す
  - 接続状態 (disconnected, connecting, connected, reconnecting) を ref で公開
  - コンポーネントアンマウント時に自動切断
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 2.2 自動再接続ロジックを実装する
  - 接続切断時に exponential backoff で再接続を試行
  - Last-Event-ID を送信して未取得イベントを再取得
  - 最大リトライ回数を設定し、超過時はエラーコールバックを呼び出す
  - 再接続中は接続状態インジケーターを更新
  - _Requirements: 3.4, 3.5, 3.6_

## Task 3: セッション作成画面の実装

- [ ] 3.1 プレイヤー入力フォームコンポーネントを作成する
  - プレイヤー ID と表示名の入力フィールドを動的に追加/削除
  - プレイヤー数 2〜7 人の範囲でバリデーション
  - プレイヤー ID 重複時にエラーメッセージを表示
  - 送信ボタンの有効/無効制御
  - タッチ操作に適したボタンサイズ (最小 44x44px)
  - _Requirements: 1.3, 1.4, 7.2_

- [ ] 3.2 セッション作成ページを実装する
  - フォーム送信時に POST /sessions API を呼び出す
  - API 呼び出し中はローディングインジケーターを表示
  - 成功時はセッション ID を含むゲーム画面へ遷移
  - API エラー時は日本語エラーメッセージを表示
  - _Requirements: 1.1, 1.2, 1.5, 1.6_

## Task 4: ゲーム盤面コンポーネントの実装

- [ ] 4.1 (P) 中央カードとポット表示コンポーネントを作成する
  - 中央に公開されているカード番号を大きく表示
  - カードがない場合は空の状態を表示
  - 中央ポットのチップ数をカードの下に表示
  - ゲームフェーズに応じたスタイル変更
  - _Requirements: 2.2, 2.5_

- [ ] 4.2 (P) プレイヤー情報パネルコンポーネントを作成する
  - プレイヤー名、所持チップ数を表示
  - 獲得済みカードを連番でグループ化して表示
  - 現在の手番プレイヤーをハイライト表示
  - 自分自身のパネルを識別可能なスタイルで表示
  - _Requirements: 2.3, 2.4_

## Task 5: アクション実行機能の実装

- [ ] 5.1 アクションボタンパネルコンポーネントを作成する
  - 「チップを置く」「カードを取る」の 2 つのボタンを配置
  - 自分の手番でない場合はボタンを無効化
  - チップ残量が 0 の場合は「チップを置く」を無効化
  - アクション送信中はローディング状態を表示
  - タッチ操作に適したボタンサイズ
  - _Requirements: 4.1, 4.2, 4.5, 4.7, 7.2_

- [ ] 5.2 アクション送信ロジックをゲームページに実装する
  - ボタンクリック時に POST /sessions/{id}/actions API を呼び出す
  - placeChip または takeCard アクションを送信
  - state_version を含めて競合を検出
  - 409 エラー時は SSE で最新状態を受信後に再試行
  - _Requirements: 4.3, 4.4, 4.6_

## Task 6: ルールヒント機能の実装

- [ ] 6.1 (P) ルールヒント表示コンポーネントを作成する
  - ヒントテキストを UI に表示
  - emphasis が "warning" の場合は警告スタイルで強調
  - 表示/非表示のトグルボタンを配置
  - _Requirements: 5.2, 5.3, 5.4_

- [ ] 6.2 ヒント取得ロジックをゲームページに実装する
  - ゲーム状態更新時に GET /sessions/{id}/hint API を呼び出す
  - 取得したヒントをコンポーネントに渡す
  - _Requirements: 5.1_

## Task 7: ゲーム結果表示機能の実装

- [ ] 7.1 (P) 結果表示パネルコンポーネントを作成する
  - プレイヤーの順位、スコア、残チップ数、獲得カードを表示
  - 勝者をハイライト表示
  - 同点タイブレーク情報を表示
  - 新しいゲームを開始するボタンを配置
  - _Requirements: 6.2, 6.3, 6.4, 6.5_

- [ ] 7.2 結果取得ロジックをゲームページに実装する
  - ゲーム完了時に GET /sessions/{id}/results API を呼び出す
  - 取得した結果を結果表示パネルに渡す
  - 新しいゲーム開始ボタンでセッション作成画面へ遷移
  - _Requirements: 6.1_

## Task 8: ゲームページの統合実装

- [ ] 8.1 ゲームページの状態管理とライフサイクルを実装する
  - ページロード時に GET /sessions/{id}/state で初期状態を取得
  - SSE 接続を確立しリアルタイム更新を受信
  - state.delta イベントで状態を更新し UI を再描画
  - state.final イベントで完了状態に遷移
  - ページ離脱時に SSE 接続を切断
  - _Requirements: 2.1, 3.1, 3.2, 3.3_

- [ ] 8.2 ゲームページのレイアウトとコンポーネント統合を行う
  - 中央盤面、プレイヤーパネル、アクションパネル、ヒントパネルを配置
  - ゲームフェーズに応じた表示切り替え (running → 盤面, completed → 結果)
  - 接続状態インジケーターを表示
  - エラー表示コンポーネントを統合
  - _Requirements: 2.5, 2.6, 3.5_

- [ ] 8.3 レスポンシブレイアウトを適用する
  - モバイル (〜640px): 縦積みレイアウト
  - タブレット (641px〜1024px): 2 カラムレイアウト
  - デスクトップ (1025px〜): 横並びレイアウト
  - 横向き・縦向き両方のオリエンテーションに対応
  - _Requirements: 7.1, 7.3_

## Task 9: テストの実装

- [ ] 9.1 useSSE Composable のユニットテストを作成する
  - 接続/切断の正常系テスト
  - イベント受信時のコールバック呼び出しテスト
  - 再接続ロジックのテスト
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 9.2 (P) errorMessages ユーティリティのユニットテストを作成する
  - 各エラーコードが正しい日本語メッセージに変換されることを確認
  - 未知のエラーコードに対するフォールバック動作を確認
  - _Requirements: 8.5_

- [ ]* 9.3 (P) コンポーネントの基本レンダリングテストを作成する
  - SessionForm のバリデーション動作テスト
  - GameBoard の Props に応じた表示テスト
  - ActionPanel の有効/無効状態テスト
  - _Requirements: 1.3, 1.4, 2.2, 4.1, 4.2, 4.5_
